name: Build iOS IPA (GitHub Releases)

# Workflow nÃ y sá»­ dá»¥ng GitHub Releases Ä‘á»ƒ lÆ°u trá»¯ file LFS lá»›n
# Download tá»« Releases thay vÃ¬ Git LFS â†’ KhÃ´ng tá»‘n LFS bandwidth

on:
  workflow_dispatch:
    inputs:
      build_configuration:
        description: 'Build configuration (Release or Debug)'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug

jobs:
  build-ipa:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository (without LFS)
      uses: actions/checkout@v4
      with:
        lfs: false  # KhÃ´ng fetch LFS
        fetch-depth: 0
    
    - name: Download large files from GitHub Releases
      run: |
        echo "ðŸ“¥ Downloading large files from GitHub Releases..."
        
        # ============================================
        # âš™ï¸ Cáº¤U HÃŒNH: Thay Ä‘á»•i 2 dÃ²ng nÃ y
        # ============================================
        RELEASE_TAG="v1.0.20251114-172255"  # ðŸ‘ˆ Thay báº±ng tag release cá»§a báº¡n (vÃ­ dá»¥: v1.0.0, v1.0.1, ...)
        ASSET_NAME="xcode-assets.zip"  # ðŸ‘ˆ Thay báº±ng tÃªn file ZIP báº¡n Ä‘Ã£ upload (vÃ­ dá»¥: xcode-assets.zip)
        # ============================================
        
        REPO="${{ github.repository }}"
        OWNER=$(echo "$REPO" | cut -d'/' -f1)
        REPO_NAME=$(echo "$REPO" | cut -d'/' -f2)
        
        echo "ðŸ” TÃ¬m Release: $RELEASE_TAG trong repository $REPO"
        
        # Láº¥y thÃ´ng tin Release tá»« GitHub API
        RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/$REPO/releases/tags/$RELEASE_TAG" || echo "")
        
        if [ -z "$RELEASE_INFO" ] || echo "$RELEASE_INFO" | grep -q "Not Found"; then
          echo "âŒ Lá»—i: KhÃ´ng tÃ¬m tháº¥y Release vá»›i tag '$RELEASE_TAG'"
          echo "ðŸ’¡ HÃ£y kiá»ƒm tra:"
          echo "   1. Tag release cÃ³ Ä‘Ãºng khÃ´ng? (vÃ­ dá»¥: v1.0.0)"
          echo "   2. Release Ä‘Ã£ Ä‘Æ°á»£c publish chÆ°a? (khÃ´ng pháº£i draft)"
          echo "   3. Xem hÆ°á»›ng dáº«n trong file GITHUB_RELEASES_GUIDE.md"
          exit 1
        fi
        
        # TÃ¬m asset ID tá»« tÃªn file
        ASSET_ID=$(echo "$RELEASE_INFO" | grep -o "\"id\":[0-9]*,\"name\":\"$ASSET_NAME\"" | grep -o "\"id\":[0-9]*" | cut -d':' -f2 || echo "")
        
        if [ -z "$ASSET_ID" ]; then
          echo "âŒ Lá»—i: KhÃ´ng tÃ¬m tháº¥y file '$ASSET_NAME' trong Release '$RELEASE_TAG'"
          echo "ðŸ’¡ CÃ¡c file cÃ³ sáºµn trong Release:"
          echo "$RELEASE_INFO" | grep -o "\"name\":\"[^\"]*\"" | sed 's/"name":"//g' | sed 's/"//g' || echo "   (KhÃ´ng cÃ³ file nÃ o)"
          echo ""
          echo "ðŸ’¡ HÃ£y kiá»ƒm tra:"
          echo "   1. TÃªn file cÃ³ Ä‘Ãºng khÃ´ng? (vÃ­ dá»¥: xcode-assets.zip)"
          echo "   2. File Ä‘Ã£ Ä‘Æ°á»£c upload vÃ o Release chÆ°a?"
          exit 1
        fi
        
        echo "âœ… TÃ¬m tháº¥y file: $ASSET_NAME (ID: $ASSET_ID)"
        
        # Táº¡o thÆ° má»¥c táº¡m
        mkdir -p XCODE/temp
        
        # Download file tá»« GitHub Releases
        echo "â¬‡ï¸ Äang download $ASSET_NAME..."
        curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/octet-stream" \
          "https://api.github.com/repos/$REPO/releases/assets/$ASSET_ID" \
          -o "XCODE/temp/$ASSET_NAME" || {
          echo "âŒ Lá»—i: KhÃ´ng thá»ƒ download file"
          exit 1
        }
        
        # Kiá»ƒm tra file Ä‘Ã£ download
        if [ ! -f "XCODE/temp/$ASSET_NAME" ]; then
          echo "âŒ Lá»—i: File khÃ´ng Ä‘Æ°á»£c download"
          exit 1
        fi
        
        FILE_SIZE=$(ls -lh "XCODE/temp/$ASSET_NAME" | awk '{print $5}')
        echo "âœ… Download thÃ nh cÃ´ng: $ASSET_NAME ($FILE_SIZE)"
        
        # Giáº£i nÃ©n file
        echo "ðŸ“¦ Äang giáº£i nÃ©n $ASSET_NAME..."
        cd XCODE
        unzip -q "temp/$ASSET_NAME" -d . || {
          echo "âŒ Lá»—i: KhÃ´ng thá»ƒ giáº£i nÃ©n file ZIP"
          echo "ðŸ’¡ Kiá»ƒm tra file ZIP cÃ³ bá»‹ há»ng khÃ´ng"
          exit 1
        }
        cd ..
        
        # XÃ³a file ZIP táº¡m
        rm -f "XCODE/temp/$ASSET_NAME"
        rmdir "XCODE/temp" 2>/dev/null || true
        
        echo "âœ… HoÃ n táº¥t! File Ä‘Ã£ Ä‘Æ°á»£c giáº£i nÃ©n vÃ o thÆ° má»¥c XCODE/"
        
        # Kiá»ƒm tra cÃ¡c thÆ° má»¥c quan trá»ng
        if [ -d "XCODE/Data" ]; then
          echo "âœ… ThÆ° má»¥c Data/ Ä‘Ã£ cÃ³"
        else
          echo "âš ï¸ Cáº£nh bÃ¡o: ThÆ° má»¥c Data/ khÃ´ng tÃ¬m tháº¥y"
        fi
        
        if [ -d "XCODE/Libraries" ]; then
          echo "âœ… ThÆ° má»¥c Libraries/ Ä‘Ã£ cÃ³"
        else
          echo "âš ï¸ Cáº£nh bÃ¡o: ThÆ° má»¥c Libraries/ khÃ´ng tÃ¬m tháº¥y"
        fi
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Set build configuration
      id: config
      run: |
        CONFIG="${{ github.event.inputs.build_configuration }}"
        echo "config=${CONFIG:-Release}" >> $GITHUB_OUTPUT
        echo "Build configuration: ${CONFIG:-Release}"
        
    - name: Build and Archive
      run: |
        cd XCODE
        
        BUILD_CONFIG="${{ steps.config.outputs.config }}"
        SCHEME="Unity-iPhone"
        ARCHIVE_PATH="./build/Unity-iPhone.xcarchive"
        
        mkdir -p build/export
        
        xcodebuild clean \
          -project Unity-iPhone.xcodeproj \
          -scheme "$SCHEME" \
          -configuration "$BUILD_CONFIG" || true
        
        xcodebuild archive \
          -project Unity-iPhone.xcodeproj \
          -scheme "$SCHEME" \
          -configuration "$BUILD_CONFIG" \
          -archivePath "$ARCHIVE_PATH" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -destination "generic/platform=iOS" || {
            echo "Archive with no signing failed, trying with automatic signing..."
            xcodebuild archive \
              -project Unity-iPhone.xcodeproj \
              -scheme "$SCHEME" \
              -configuration "$BUILD_CONFIG" \
              -archivePath "$ARCHIVE_PATH" \
              -destination "generic/platform=iOS"
          }
        
    - name: Create IPA manually
      run: |
        cd XCODE
        ARCHIVE_PATH="./build/Unity-iPhone.xcarchive"
        EXPORT_PATH="./build/export"
        
        if [ -d "$ARCHIVE_PATH/Products/Applications" ]; then
          APP_BUNDLE=$(find "$ARCHIVE_PATH/Products/Applications" -name "*.app" -type d | head -1)
          
          if [ -n "$APP_BUNDLE" ]; then
            APP_NAME=$(basename "$APP_BUNDLE" .app)
            IPA_NAME="${APP_NAME}.ipa"
            
            rm -rf "$EXPORT_PATH/Payload"
            mkdir -p "$EXPORT_PATH/Payload"
            cp -R "$APP_BUNDLE" "$EXPORT_PATH/Payload/"
            
            cd "$EXPORT_PATH"
            zip -r "$IPA_NAME" Payload/ -q
            cd ../..
            
            echo "âœ… IPA created: $EXPORT_PATH/$IPA_NAME"
            ls -lh "$EXPORT_PATH/$IPA_NAME"
          fi
        fi
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: NROFLY.ipa
        path: XCODE/build/export/*.ipa
        retention-days: 30
        if-no-files-found: warn
        compression-level: 0

